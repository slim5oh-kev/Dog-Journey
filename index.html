<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Dogs’ Road Trip Journey</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
        crossorigin=""/>
  <style>
    :root { --bg:#0b0f14; --panel:#111827; --text:#e5e7eb; --muted:#9ca3af; --border:#1f2937; }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background:var(--bg); color:var(--text); }
    header { padding:14px 16px; border-bottom:1px solid var(--border); display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
    header h1 { margin:0; font-size:18px; font-weight:700; letter-spacing:0.2px; }
    header .sub { color:var(--muted); font-size:13px; }
    main { display:grid; grid-template-columns: 1fr 360px; gap:0; height: calc(100vh - 58px); }
    #map { height:100%; width:100%; }
    aside { border-left:1px solid var(--border); background:var(--panel); overflow:auto; }
    .card { padding:14px; border-bottom:1px solid var(--border); }
    .stop { display:grid; grid-template-columns: 72px 1fr; gap:12px; align-items:center; }
    .thumb { width:72px; height:72px; border-radius:12px; overflow:hidden; background:#0b1220; border:1px solid var(--border); display:flex; align-items:center; justify-content:center; }
    .thumb img { width:100%; height:100%; object-fit:cover; display:block; }
    .meta .title { font-weight:700; }
    .meta .desc { color:var(--muted); font-size:13px; margin-top:2px; line-height:1.35; }
    .meta .date { color:var(--muted); font-size:12px; margin-top:6px; }
    .pill { display:inline-block; padding:2px 8px; border:1px solid var(--border); border-radius:999px; font-size:12px; color:var(--muted); margin-top:6px; }
    .popup { max-width:260px; }
    .popup img { width:100%; border-radius:12px; border:1px solid var(--border); }
    .popup .p-title { font-weight:800; margin:8px 0 2px; }
    .popup .p-desc { color:var(--muted); font-size:13px; margin:0; }
    @media (max-width: 900px) {
      main { grid-template-columns: 1fr; grid-template-rows: 60vh auto; }
      aside { border-left:none; border-top:1px solid var(--border); }
    }
  </style>
</head>
<body>
<header>
  <div>
    <h1>Bentley and Duke headed to Tegucigalpa!</h1>
    <div class="sub">Follow us on our adventure!</code>)</div>
  </div>
</header>

<main>
  <div id="map"></div>
  <aside id="list"></aside>
</main>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
        crossorigin=""></script>
<script>
  // --- Basic helpers
  function escapeHtml(str) {
    return (str ?? "").toString()
      .replaceAll("&", "&amp;")
      .replaceAll("<", "&lt;")
      .replaceAll(">", "&gt;")
      .replaceAll('"', "&quot;")
      .replaceAll("'", "&#039;");
  }

  // --- Map setup
  const map = L.map('map', { zoomControl: true });
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19,
    attribution: '&copy; OpenStreetMap contributors'
  }).addTo(map);

  const routeLayer = L.polyline([], { weight: 4, opacity: 0.85 }).addTo(map);
  const markerLayer = L.layerGroup().addTo(map);

  async function loadStops() {
    const res = await fetch('./stops.json', { cache: 'no-store' });
    if (!res.ok) throw new Error('Could not load stops.json');
    const data = await res.json();
    if (!Array.isArray(data.stops)) throw new Error('stops.json is missing a "stops" array');
    return data.stops;
  }

  function makeThumbIcon(thumbUrl) {
    // A marker icon that uses the stop's thumbnail
    return L.divIcon({
      className: '',
      iconSize: [54, 54],
      iconAnchor: [27, 54],
      popupAnchor: [0, -50],
      html: `
        <div style="width:54px;height:54px;border-radius:16px;overflow:hidden;border:2px solid rgba(255,255,255,0.25);box-shadow:0 10px 25px rgba(0,0,0,0.35);background:#0b1220">
          <img src="${escapeHtml(thumbUrl)}" style="width:100%;height:100%;object-fit:cover;display:block" />
        </div>
      `
    });
  }

  function renderList(stops) {
    const list = document.getElementById('list');
    list.innerHTML = '';
    stops.forEach((s, idx) => {
      const card = document.createElement('div');
      card.className = 'card';
      const title = `${s.city}, ${s.region ? s.region + ', ' : ''}${s.country}`;
      const desc = s.note || '';
      const date = s.date ? new Date(s.date).toLocaleDateString(undefined, { year:'numeric', month:'short', day:'numeric'}) : '';
      card.innerHTML = `
        <div class="stop" role="button" tabindex="0" data-idx="${idx}">
          <div class="thumb">${s.thumb ? `<img alt="" src="${escapeHtml(s.thumb)}">` : ''}</div>
          <div class="meta">
            <div class="title">${escapeHtml(title)}</div>
            ${desc ? `<div class="desc">${escapeHtml(desc)}</div>` : ''}
            ${date ? `<div class="date">${escapeHtml(date)}</div>` : ''}
            <div class="pill">${idx+1} / ${stops.length}</div>
          </div>
        </div>
      `;
      card.querySelector('.stop').addEventListener('click', () => focusStop(idx, stops));
      card.querySelector('.stop').addEventListener('keydown', (e) => { if (e.key === 'Enter') focusStop(idx, stops); });
      list.appendChild(card);
    });
  }

  let markers = [];
  function renderMap(stops) {
    markerLayer.clearLayers();
    markers = [];

    const latlngs = [];
    stops.forEach((s, idx) => {
      if (typeof s.lat !== 'number' || typeof s.lng !== 'number') return;
      const ll = [s.lat, s.lng];
      latlngs.push(ll);

      const title = `${s.city}, ${s.region ? s.region + ', ' : ''}${s.country}`;
      const popup = `
        <div class="popup">
          ${s.photo ? `<img alt="" src="${escapeHtml(s.photo)}">` : ''}
          <div class="p-title">${escapeHtml(title)}</div>
          ${s.note ? `<p class="p-desc">${escapeHtml(s.note)}</p>` : ''}
        </div>
      `;

      const m = L.marker(ll, { icon: s.thumb ? makeThumbIcon(s.thumb) : undefined })
        .addTo(markerLayer)
        .bindPopup(popup);

      m.on('click', () => highlightInList(idx));
      markers.push(m);
    });

    routeLayer.setLatLngs(latlngs);

    if (latlngs.length) {
      const bounds = L.latLngBounds(latlngs);
      map.fitBounds(bounds.pad(0.25));
    } else {
      map.setView([20, -70], 3); // fallback view
    }
  }

  function highlightInList(idx) {
    const el = document.querySelector(`[data-idx="${idx}"]`);
    if (el) el.scrollIntoView({ behavior: 'smooth', block: 'center' });
  }

  function focusStop(idx, stops) {
    const s = stops[idx];
    if (!s || typeof s.lat !== 'number' || typeof s.lng !== 'number') return;
    map.setView([s.lat, s.lng], Math.max(map.getZoom(), 9), { animate: true });
    const m = markers[idx];
    if (m) m.openPopup();
  }

  (async () => {
    try {
      const stops = await loadStops();
      // Ensure they are sorted by "order" if present, otherwise keep file order.
      stops.sort((a,b) => (a.order ?? 9999) - (b.order ?? 9999));
      renderList(stops);
      renderMap(stops);
    } catch (err) {
      console.error(err);
      document.getElementById('list').innerHTML =
        `<div class="card">Couldn’t load <code>stops.json</code>. If you’re opening this by double-clicking the file, run a local server instead (see README).</div>`;
      map.setView([20, -70], 3);
    }
  })();
</script>
</body>
</html>
